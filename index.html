// --- Part 1: Handle the callback from Square POS app after a payment ---
            const transactionId = urlParams.get('com.squareup.pos.SERVER_TRANSACTION_ID');
            const errorMessage = urlParams.get('com.squareup.pos.RESULT_ERROR_MESSAGE');
            const errorCode = urlParams.get('com.squareup.pos.RESULT_ERROR_CODE');
            // NEW: Get the AppSheet row ID from the URL
            const appsheetRowId = urlParams.get('appsheet_row_id'); 
            const contentDiv = document.getElementById('content');
            const APPSHEET_APP_ID = "YOUR_APPSHEET_APP_ID"; // IMPORTANT: Replace with your actual App ID

            if (transactionId) {
                // Payment was successful.
                let redirectLink = "";
                if (appsheetRowId) {
                    // Construct the deep link back to the specific row in AppSheet
                    redirectLink = `https://www.appsheet.com/start/${APPSHEET_APP_ID}#view=Transactions_Detail&row=${appsheetRowId}`;
                }

                contentDiv.innerHTML = `
                    <h1 class="text-2xl font-bold mb-4 text-green-600">Payment Successful!</h1>
                    <p class="text-gray-600 mb-2">Transaction ID:</p>
                    <p class="font-mono text-sm text-gray-700 break-all">${transactionId}</p>
                    <p class="mt-4 text-gray-600">You can now return to your AppSheet app.</p>
                    ${redirectLink ? `<a href="${redirectLink}" class="mt-4 inline-block bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Return to AppSheet</a>` : ''}
                `;
            } else if (errorMessage) {
                // Payment failed.
                // ... (no changes needed here)
            } else {
                const amountRaw = urlParams.get('amount');
                const noteRaw = urlParams.get('customer_note');
                // NEW: Get the AppSheet row ID for the initial launch
                const initialAppsheetRowId = urlParams.get('appsheet_row_id'); 

                // Your Square credentials
                const SQUARE_APP_ID = "sq0idp-CprTqUDpijlIs21eQSpeJQ";
                const SQUARE_LOCATION_ID = "L4DPK1HDFRXMK";
                const CALLBACK_URL = `https://mycoappllcpos.github.io/square-pos-launcher/?appsheet_row_id=${encodeURIComponent(initialAppsheetRowId)}`;
