<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Square POS Launcher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div id="content" class="p-8 bg-white rounded-lg shadow-lg max-w-lg w-full text-center">
        <!-- Content will be dynamically updated by JavaScript -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const urlSearchString = window.location.search;
            const urlParams = new URLSearchParams(urlSearchString);
            const transactionId = urlParams.get('com.squareup.pos.SERVER_TRANSACTION_ID');
            const errorMessage = urlParams.get('com.squareup.pos.RESULT_ERROR_MESSAGE');
            const errorCode = urlParams.get('com.squareup.pos.RESULT_ERROR_CODE');
            const contentDiv = document.getElementById('content');

            // --- Part 1: Handle the callback from Square POS app ---
            if (transactionId) {
                // Payment was successful.
                contentDiv.innerHTML = `
                    <h1 class="text-2xl font-bold mb-4 text-green-600">Payment Successful!</h1>
                    <p class="text-gray-600 mb-2">Transaction ID:</p>
                    <p class="font-mono text-sm text-gray-700 break-all">${transactionId}</p>
                    <p class="mt-4 text-gray-600">You can now return to your AppSheet app to view the updated status.</p>
                `;
            } else if (errorMessage) {
                // Payment failed.
                contentDiv.innerHTML = `
                    <h1 class="text-2xl font-bold mb-4 text-red-600">Payment Failed</h1>
                    <p class="text-gray-600 mb-2">Error: ${errorMessage}</p>
                    <p class="text-gray-600 mb-2">Error Code: ${errorCode}</p>
                    <p class="text-gray-600 mt-4">Please try again or contact support.</p>
                `;
            } 
            // --- Part 2: Trigger the Square POS app if amount parameter exists ---
            else {
                const amountRaw = urlParams.get('amount');
                const noteRaw = urlParams.get('note');

                if (amountRaw && noteRaw) {
                    // Your Square credentials
                    const SQUARE_APP_ID = "sq0idp-CprTqUDpijlIs21eQSpeJQ";
                    const SQUARE_LOCATION_ID = "L4DPK1HDFRXMK";
                    const CALLBACK_URL = "https://mycoappllcpos.github.io/square-pos-launcher/";

                    // Sanitize and convert the AppSheet data
                    const amountInCents = Math.floor(parseFloat(amountRaw) * 100);
                    const encodedNote = encodeURIComponent(noteRaw);

                    function getMobileOS() {
                        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                        if (/android/i.test(userAgent)) {
                            return "Android";
                        }
                        if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                            return "iOS";
                        }
                        return "unknown";
                    }

                    const os = getMobileOS();
                    let posUrl = '';
                    
                    // Construct the URL differently for iOS and Android
                    if (os === 'iOS') {
                        const transactionData = {
                            'amount_money': {
                                'amount': amountInCents,
                                'currency_code': 'USD'
                            },
                            'callback_url': CALLBACK_URL,
                            'client_id': SQUARE_APP_ID,
                            'version': '1.3',
                            'notes': noteRaw, // Note is not URL encoded for iOS
                            'location_id': SQUARE_LOCATION_ID
                        };
                        const jsonString = JSON.stringify(transactionData);
                        const encodedData = encodeURIComponent(jsonString);
                        posUrl = `square-commerce-v1://payment/create?data=${encodedData}`;

                    } else if (os === 'Android') {
                        const fallbackUrl = `https://play.google.com/store/apps/details?id=com.squareup`;
                        posUrl = `intent:#Intent;action=com.squareup.pos.action.CHARGE;package=com.squareup;S.browser_fallback_url=${encodeURIComponent(fallbackUrl)};S.com.squareup.pos.WEB_CALLBACK_URI=${encodeURIComponent(CALLBACK_URL)};S.com.squareup.pos.CLIENT_ID=${SQUARE_APP_ID};S.com.squareup.pos.API_VERSION=v2.0;i.com.squareup.pos.TOTAL_AMOUNT=${amountInCents};S.com.squareup.pos.CURRENCY_CODE=USD;S.com.squareup.pos.NOTE=${encodedNote};S.com.squareup.pos.LOCATION_ID=${SQUARE_LOCATION_ID};end`;
                    } else {
                        contentDiv.innerHTML = '<h1 class="text-2xl font-bold mb-4 text-red-600">Error</h1><p class="text-gray-600">This feature is only available on iOS and Android mobile devices.</p>';
                        return;
                    }

                    contentDiv.innerHTML = `
                        <h1 class="text-2xl font-bold mb-4 text-gray-800">Ready to Launch Square App</h1>
                        <p class="text-gray-600 mb-6">Click the button below to open the Square POS app and process the payment.</p>
                        <a href="${posUrl}" class="inline-block bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                            Launch Square POS
                        </a>
                        <div class="mt-8 text-left">
                            <p class="text-gray-600 font-semibold">Debug Information:</p>
                            <p class="font-mono text-sm text-gray-500">Amount Received: <span class="text-gray-800">${amountRaw}</span></p>
                            <p class="font-mono text-sm text-gray-500">Note Received: <span class="text-gray-800">${noteRaw}</span></p>
                            <p class="font-mono text-sm text-gray-500">Amount in Cents: <span class="text-gray-800">${amountInCents}</span></p>
                            <p class="font-mono text-sm text-gray-500">Operating System: <span class="text-gray-800">${os}</span></p>
                            <p class="text-gray-600 font-semibold mt-4">Generated Deep Link URL:</p>
                            <p class="font-mono text-xs text-gray-500 break-all">${posUrl}</p>
                        </div>
                    `;

                } else {
                    contentDiv.innerHTML = '<h1 class="text-2xl font-bold mb-4 text-red-600">Error</h1><p class="text-gray-600">Missing "amount" or "note" parameter in the URL. Please use this link from your AppSheet app after saving the transaction.</p>';
                }
            }
        });
    </script>
</body>
</html>
